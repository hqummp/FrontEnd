<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>居民诉求管理系统</title><!-- Bootstrap Styles-->
<link href="assets/css/bootstrap.css" rel="stylesheet"/>
<!-- FontAwesome Styles-->
<link href="assets/css/font-awesome.css" rel="stylesheet"/>
<!-- Morris Chart Styles-->
<link href="assets/js/morris/morris-0.4.3.min.css" rel="stylesheet"/>
<!-- Custom Styles-->
<link href="assets/css/custom-styles.css" rel="stylesheet"/>
<!-- Google Fonts-->
<link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'/>
<!-- TABLE STYLES-->
<link href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" rel="stylesheet"/>
<link href="https://cdn.datatables.net/buttons/1.5.2/css/buttons.dataTables.min.css" rel="stylesheet"/>
<link href="assets/css/message.css" type="text/css" rel="stylesheet">
<link href="assets/css/datepicker.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.1/css/buttons.dataTables.min.css">
</head>
<body>
<div id="wrapper">
	<nav class="navbar navbar-default top-navbar" role="navigation">
	<div class="navbar-header">
		<a class="navbar-brand" href="index.html">管理系统</a>
	</div>
	<ul class="nav navbar-top-links navbar-right">
		<li class="dropdown">
		<a class="dropdown-toggle" data-toggle="dropdown" href="#" aria-expanded="false">
		<i class="fa fa-user fa-fw"></i><i class="fa fa-caret-down"></i>
		</a>
		<ul class="dropdown-menu dropdown-user">
			<li><a href="#"><i class="fa fa-user fa-fw"></i> admin</li>
			<li><a href="#"><i class="fa fa-sign-out fa-fw"></i> Logout</a>
			</li>
		</ul>
		</li>
	</ul>
	</nav>
	<nav class="navbar-default navbar-side" role="navigation">
	<div class="sidebar-collapse">
		<ul class="nav" id="main-menu">
			<li>
			<a href="index.html"><i class="fa fa-dashboard"></i> 总览</a>
			</li>
			<li>
			<a href="form.html"><i class="fa fa-edit"></i> 信息提交</a>
			</li>
			<li>
			<a class="active-menu" href="table.html"><i class="fa fa-table"></i> 综合查询</a>
			</li>
			<li>
			<a href="chart.html"><i class="fa fa-bar-chart-o"></i> 图表</a>
			</li>
			<li>
			<a href="#"><i class="fa fa-sitemap"></i> 事件分类查询<span class="fa arrow"></span></a>
			<ul class="nav nav-second-level">
				<li>
				<a href="issues/city-management.html">城市管理</a>
				</li>
				<li>
				<a href="issues/planning-construction.html">规划建设</a>
				</li>
				<li>
				<a href="issues/house-removal.html">征地拆迁</a>
				</li>
				<li>
				<a href="issues/contract-dispute.html">合同纠纷</a>
				</li>
				<li>
				<a href="issues/property-management.html">物业管理</a>
				</li>
				<li>
				<a href="issues/environment-protection.html">环境保护</a>
				</li>
				<li>
				<a href="issues/social-affairs.html">社会事务</a>
				</li>
				<li>
				<a href="issues/public-security.html">社会治安</a>
				</li>
				<li>
				<a href="issues/staff-administration.html">干部管理</a>
				</li>
				<li>
				<a href="issues/general-election.html">换届选举</a>
				</li>
			</ul>
			</li>
			<li>
			<a href="#"><i class="fa fa-sitemap"></i> 平台分类查询<span class="fa arrow"></span></a>
			<ul class="nav nav-second-level">
				<li>
				<a href="platform/mayor-phone.html">市长公开电话</a>
				</li>
				<li>
				<a href="platform/mayor-mailbox.html">市长信箱</a>
				</li>
				<li>
				<a href="platform/new-web.html">网络新媒体</a>
				</li>
				<li>
				<a href="platform/warden-mailbox.html">区长信箱</a>
				</li>
				<li>
				<a href="platform/renmin-website.html">人民网</a>
				</li>
				<li>
				<a href="platform/hotline.html">文明热线</a>
				</li>
				<li>
				<a href="platform/web-politic.html">网络理政</a>
				</li>
			</ul>
			</li>
		</ul>
	</div>
	</nav>
	<!-- /. NAV SIDE  -->
	<div id="page-wrapper">
		<div id="page-inner">
			<div class="row">
				<div class="col-md-12">
					<h1 class="page-header">
                            综合查询
					</h1>
				</div>
			</div>
			<!-- /. ROW  -->
			<div class="row">
				<div class="col-md-12">
					<!-- Advanced Tables -->
					<div class="panel panel-default">
						<div class="panel-heading">
                             所有信息
						</div>
						<div class="panel-body">
							<div class="table-responsive">
								<table class="table table-striped table-bordered table-hover" id="Table">
								<thead>
								<tr>
									<th width="13%">
										反映平台
									</th>
									<th width="7%">
										日期
									</th>
									<th width="5%">
										年
									</th>
									<th width="2%">
										月
									</th>
									<th width="2%">
										日
									</th>
									<th width="8%">
										事件类别
									</th>
									<th>
										反映内容
									</th>
									<th width="15%">
										操作
									</th>
								</tr>
								</thead>
								</table>
								<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
                                	<div class="modal-dialog">
                                    	<div class="modal-content">
                                        	<div class="modal-header">
                                            	<button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                            	<h4 class="modal-title" id="myModalLabel">确认删除</h4>
                                        	</div>
                                        	<div class="modal-body">
												<h4 style="color: #d43f3a"><b>此操作不可撤销!</b></h4>
												确认删除？
												<br/>
                                            </div>
                                        	<div class="modal-footer">
                                            	<button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                            	<button id="delete-confirm" type="button" class="btn btn-danger">确认删除</button>
                                        	</div>
                                    	</div>
                                	</div>
                            	</div>
								<div class="modal fade" id="modifyModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
	                                <div class="modal-dialog">
	                                    <div class="modal-content">
	                                        <div class="modal-header">
	                                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	                                            <h4 class="modal-title" id="myModalLabel">信息修改</h4>
	                                        </div>
	                                        <div class="modal-body" style="padding: 0px;">
												<div class="col-lg-6">
				                                    <h4>反应相关分类信息</h4>
													<form role="form">
														<div class="form-group">
				                                            <label>请填写日期</label>
				                                            <br/>
				                                            <div id="timepicker" class="c-datepicker-date-editor c-datepicker-single-editor J-datepicker-day mt10">
				                                                <i class="c-datepicker-range__icon kxiconfont icon-clock"></i>
				                                                <input id="timepicker-value" type="text" autocomplete="off" name="" placeholder="选择日期" class=" c-datepicker-data-input only-date" value="">
				                                            </div>
														</div>
				                                        <div>
															<label>反应平台</label>
															<select id="source-select" class="form-control">
				                                                <option>市长公开电话</option>
				                                                <option>市长信箱</option>
				                                                <option>网络新媒体</option>
				                                                <option>区长信箱</option>
				                                                <option>人民网</option>
				                                                <option>文明办</option>
				                                                <option>网络理政信箱督办单</option>
				                                            </select>
														</div>
				                                        <div class="form-group">
															<label>反应问题</label>
															<select id="issue-select" class="form-control">
				                                                <option>环境保护</option>
				                                                <option>城市管理</option>
				                                                <option>社会事务</option>
				                                                <option>规划建设</option>
				                                                <option>征地拆迁</option>
				                                                <option>物业管理</option>
				                                                <option>干部管理</option>
				                                                <option>合同纠纷</option>
				                                                <option>社会治安</option>
				                                                <option>换届选举</option>
				                                            </select>
														</div>
														<div class="form-group">
															<label>附加标签</label>
															<input id="form-subtitle" class="form-control" placeholder="子问题">
														</div>
													</form>
												</div>
												<!-- /.col-lg-6 (nested) -->
												<div class="col-lg-6">
													<h4>反应内容填写</h4>
													<form role="form">
				                                        <div class="form-group">
															<label>反应内容</label>
															<textarea id="form-content" class="form-control" rows="2"></textarea>
														</div>
				                                        <div class="form-group">
															<label>详细信息</label>
															<textarea id="form-info" class="form-control" rows="4"></textarea>
														</div>
				                                        <div class="form-group">
															<label>备注</label>
															<textarea id="form-remark" class="form-control" rows="1"></textarea>
														</div>
													</form>
												</div>
												<!-- /.col-lg-6 (nested) -->
											</div>
	                                        <div class="modal-footer">
	                                            <button type="button" class="btn btn-default" data-dismiss="modal">取消修改</button>
	                                            <button id="modify-save" type="button" class="btn btn-primary">保存修改</button>
	                                        </div>
	                                    </div>
	                                </div>
	                            </div>
							</div>
						</div>
					</div>
					<!--End Advanced Tables -->
				</div>
			</div>
			<!-- /. ROW  -->
		</div>
		<footer>
		<p>
			All right reserved. LR Workshop&copy;
		</p>
		</footer>
	</div>
</div>
</div>
	<!-- /. PAGE INNER  -->
</div>
<script src="assets/js/jquery-1.10.2.js"></script>
<!-- Bootstrap Js -->
<script src="assets/js/bootstrap.min.js"></script>
<!-- Metis Menu Js -->
<script src="assets/js/jquery.metisMenu.js"></script>
<!-- DATA TABLE SCRIPTS -->
<script src="assets/js/dataTables/jquery.dataTables.js"></script>
<!-- <script src="assets/js/dataTables/dataTables.bootstrap.js"></script> -->
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.html5.min.js"></script>
<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/buttons/1.5.2/js/buttons.print.min.js"></script>
<script type="text/javascript" src="assets/js/message.js"></script>
<script src="assets/js/moment.min.js"></script>
<script src="assets/js/datepicker.all.min.js"></script>
<script>
var selected_time = [];
var table;
var remove_id;
var modify_id;
var temp_data = {};
function modifiy (_id, source, year, month, day, category, content) {
	console.log(_id + source + year + month + day + category + content);
	modify_id = _id;
	$('.J-datepicker-day').datePicker({
		hasShortcut: true,
		format: 'YYYY-MM-DD',
		shortcutOptions: [{
			name: '今天',
			day: '0'
		}, {
			name: '昨天',
			day: '-1'
		}, {
			name: '一周前',
			day: '-7'
		}],
		hide: function() {
			selected_time = this.$input.eq(0).val().split('-');
		}
	});
	console.log(selected_time);
	$("#timepicker-value").val(year + "-" + month + "-" + day)
	$('#form-content').text(content);
	var source_options = document.getElementById('source-select').children;
	switch (source) {
		case "市长公开电话":
			source_options[0].selected=true;
			break;
		case "市长信箱":
			source_options[1].selected=true;
			break;
		case "网络新媒体":
			source_options[2].selected=true;
			break;
		case "区长信箱":
			source_options[3].selected=true;
			break;
		case "人民网":
			source_options[4].selected=true;
			break;
		case "文明热线":
			source_options[5].selected=true;
			break;
		case "网络理政信箱督办单":
			source_options[6].selected=true;
			break;
	}
	var issue_option = document.getElementById('issue-select').children;
	switch (category) {
		case "环境保护":
			issue_option[0].selected=true;
			break;
		case "城市管理":
			issue_option[1].selected=true;
			break;
		case "社会事务":
			issue_option[2].selected=true;
			break;
		case "规划建设":
			issue_option[3].selected=true;
			break;
		case "征地拆迁":
			issue_option[4].selected=true;
			break;
		case "物业管理":
			issue_option[5].selected=true;
			break;
		case "干部管理":
			issue_option[6].selected=true;
			break;
		case "合同纠纷":
			issue_option[7].selected=true;
			break;
		case "社会治安":
			issue_option[8].selected=true;
			break;
		case "换届选举":
			issue_option[9].selected=true;
			break;
	}
}

function remove (_id) {
	console.log(_id);
	remove_id = _id;
}

$(function () {
	$('#delete-confirm').click(function () {
		console.log("confirmed");
		console.log(remove_id);
		$.ajax({
			type: "POST",
			url: "http://127.0.0.1:3000/delete",
			dataType: "json",
			data: {
				"remove_id": remove_id
			},
			success: function (result) {
				console.log(result);
				$('#deleteModal').fadeOut();
				$('.modal-backdrop.fade.in').fadeOut();
				$('body').removeClass("modal-open");
				$.message("删除成功");
				table.ajax.reload();
			}
		});
	});

	$('#modify-save').click(function () {
		console.log("modify confirmed");
		console.log(modify_id);
		if (selected_time.length == 3 && typeof modify_id !== "undefined") {
			$.ajax({
				type: "POST",
				url: "http://127.0.0.1:3000/modify",
				dataType: "json",
				data: {
					"data": JSON.stringify({
						"modify_id": modify_id,
						"year": selected_time[0],
						"month": selected_time[1],
						"day": selected_time[2],
						"source": $("#source-select").find("option:selected").text(),
						"category": $("#issue-select").find("option:selected").text(),
						"subcategory": "null",
						"title": "null",
						"subtitle": "null",
						"content": $("#form-content").val(),
						"detail": $("#form-info").val() || "null",
						"remark": $("#form-remark").val() || "null",
						"level": 1
					})
				},
				success: function (result) {
					console.log(result);
					$.message("修改成功");
					$('#modifyModal').fadeOut();
					$('.modal-backdrop.fade.in').fadeOut();
					$('body').removeClass("modal-open");
					table.ajax.reload();
				}
			});
		} else {
			$.message({
				message:'请填写时间',
				type:'warning'
			});
		}
	});
});

$(document).ready(function() {
	table = $('#Table').DataTable({
		language: {
			"sProcessing": "处理中...",
			"sLengthMenu": "显示 _MENU_ 项结果",
			"sZeroRecords": "没有匹配结果",
			"sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
			"sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
			"sInfoFiltered": "(由 _MAX_ 项结果过滤)",
			"sInfoPostFix": "",
			"sSearch": "搜索:",
			"sUrl": "",
			"sEmptyTable": "表中数据为空",
			"sLoadingRecords": "载入中...",
			"sInfoThousands": ",",
			"oPaginate": {
				"sFirst": "首页",
				"sPrevious": "上页",
				"sNext": "下页",
				"sLast": "末页"
			},
			"oAria": {
				"sSortAscending": ": 以升序排列此列",
				"sSortDescending": ": 以降序排列此列"
			}
		},
		dom: 'Bfrtip',
		buttons: [
			'excel', 'csv', 'copy', 'print'
		],
		ajax: function(data, callback, settings) {
			$.ajax({
				type: "GET",
				url: "http://127.0.0.1:3000/alldata",
				cache: false,
				//禁用缓存
				dataType: "json",
				success: function(result) {
					//封装返回数据
					var returnData = {};
					returnData.data = result; //返回的数据列表
					//console.log(returnData);
					//调用DataTables提供的callback方法，代表数据已封装完成并传回DataTables进行渲染
					//此时的数据需确保正确无误，异常判断应在执行此回调前自行处理完毕
					callback(returnData);
				}
			});
		},
		columns: [{
			data: 'source'
		}, {
			data: ''
		},{
			data: 'year'
		}, {
			data: 'month'
		}, {
			data: 'day'
		}, {
			data: 'category'
		}, {
			data: 'content'
		} ],
		columnDefs: [{
			targets: 7,
			render: function(data, type, row) {
				return '<div style="line-height:20px;">&nbsp;<button class="btn btn-primary" data-toggle="modal" data-target="#modifyModal" id="modifiy_' + row._id + '" onclick="modifiy(\'' + row._id + '\', \'' + row.source + '\', \'' + row.year + '\', \'' + row.month + '\', \'' + row.day + '\', \'' + row.category + '\', \'' + row.content + '\');"><i class="fa fa-edit"></i>修改</button>&nbsp;&nbsp;&nbsp;&nbsp;<button class="btn btn-danger" data-toggle="modal" data-target="#deleteModal" id="remove_' + row._id + '" onclick="remove(\'' + row._id + '\')"><i class="fa fa-pencil"></i>删除</button></div>';
			}
		}, {
			"orderable": false,
			"targets": 7
		}, {
			targets: 1,
			render: function (data, type, row) {
				return row.year + row.month + row.day;
			}
		}]
	});
});

$(function() {
	var DATAPICKERAPI = {
		// 默认input显示当前月,自己获取后填充
		activeMonthRange: function() {
			return {
				begin: moment().set({
					'date': 1,
					'hour': 0,
					'minute': 0,
					'second': 0
				}).format('YYYY-MM-DD HH:mm:ss'),
				end: moment().set({
					'hour': 23,
					'minute': 59,
					'second': 59
				}).format('YYYY-MM-DD HH:mm:ss')
			}
		},
		shortcutMonth: function() {
			// 当月
			var nowDay = moment().get('date');
			var prevMonthFirstDay = moment().subtract(1, 'months').set({
				'date': 1
			});
			var prevMonthDay = moment().diff(prevMonthFirstDay, 'days');
			return {
				now: '-' + nowDay + ',0',
				prev: '-' + prevMonthDay + ',-' + nowDay
			}
		},
		// 注意为函数：快捷选项option:只能同一个月份内的
		rangeMonthShortcutOption1: function() {
			var result = DATAPICKERAPI.shortcutMonth();
			return [{
				name: '昨天',
				day: '-1,-1',
				time: '00:00:00,23:59:59'
			}, {
				name: '这一月',
				day: result.now,
				time: '00:00:00,'
			}, {
				name: '上一月',
				day: result.prev,
				time: '00:00:00,23:59:59'
			}];
		},
		// 快捷选项option
		rangeShortcutOption1: [{
			name: '最近一周',
			day: '-7,0'
		}, {
			name: '最近一个月',
			day: '-30,0'
		}, {
			name: '最近三个月',
			day: '-90, 0'
		}],
		singleShortcutOptions1: [{
			name: '今天',
			day: '0'
		}, {
			name: '昨天',
			day: '-1',
			time: '00:00:00'
		}, {
			name: '一周前',
			day: '-7'
		}]
	};
});

</script>
<!-- Custom Js -->
<script src="assets/js/custom-scripts.js"></script>
</body>
</html>
